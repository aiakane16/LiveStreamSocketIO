<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=
    , initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>

    <button id="btn" class="muted">No Station...</button>
    <script src="socket.io.js"></script>
    <script>
     var peerConnection = window.RTCPeerConnection ||
                            window.mozRTCPeerConnection ||
                            window.webkitRTCPeerConnection ||
                            window.msRTCPeerConnection;

        var sessionDescription = window.RTCSessionDescription ||
                                window.mozRTCSessionDescription ||
                                window.webkitRTCSessionDescription ||
                                window.msRTCSessionDescription;

        navigator.getMedia = navigator.getUserMedia || 
                            navigator.webkitGetUserMedia ||
                            navigator.mozGetUserMedia ||
                            navigator.msGetUserMedia;

        var socket = io('https://3000-e30b46dc-4e8b-4cff-a247-c50875616ecd.ws-ap01.gitpod.io/')

        var pc = new peerConnection({ iceServers: [{ url: 'stun:stun.services.mozilla.com',
            username: 'myuser',
            credential: 'mycreds'
            }]
        });
        
        function error (err) {
            console.warn(err);
        }

        var offerData,
        player = new Audio(),
        btn = document.getElementById('btn');

        btn.addEventListener('click', function () {
            if (btn.getAttribute('class') === 'play') {
                listen();
                player.play();
            } else if (btn.getAttribute('class') === 'stop') {
                player.pause();
                btn.setAttribute('class', 'muted');
                btn.innerHTML = 'No Station...';
            }
        });

        function listen () {
            btn.setAttribute('class', 'stop');
            btn.innerHTML = 'Listening';

            pc.setRemoteDescription(new sessionDescription(offerData.offer), function () {
                pc.createAnswer(function (answer) {
                    pc.setLocalDescription(new sessionDescription(answer), function () {
                        socket.emit('make-answer', {
                            answer: answer,
                            to: offerData.socket
                        });
                    }, error);
                }, error);
            }, error);
        }

    pc.onaddstream = function (obj) {
        console.log('addStream');
        player.srcObject = obj.stream;
    };

    socket.on('offer-made', function (data) {
        btn.setAttribute('class', 'play');
        btn.innerHTML = 'Listen';
        offerData = data;
    });
    </script>
</body>
</html>